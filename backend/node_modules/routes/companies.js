'use strict';

var CompaniesRouter = require('express').Router(),
DBQueries = require('../db/DBQueries.js'),
Controller = require('../controller'), PGController = new Controller(),
DBService = require('../db/DBService.js'), PGService = new DBService();

/* @RequestController */
CompaniesRouter
/* @RequestService */
.get('/', function (request, response) {
  PGService.performQueryWL(
    DBQueries.selectCompaniesQuery(),
    PGService.selectRecordsWL,
    function (status, data) {
      return response.status(status)
      .json(data).end();
  });
})
/* @RequestService */
.get('/:id', function (request, response) {
  if (!request.params.id) {
    return response.status(400).end();
  }
  var company = {
    /* required */
    id: String(request.params.id)
  };
  if (PGController.validate(company, 'bin')) {
    PGService.performQueryWithoutLogging(
      DBQueries.selectCompanyQuery(company),
      PGService.selectRecord,
      function (status, data) {
        return response.status(status)
        .json(data).end();
    });
  } else {
    return response.status(400).end();
  }
})
/* @RequestService */
.post('/', function (request, response) {
  var company = {
    /* required */
    id: String(request.body.id),
    /* required length: 1 - 500 */
    companyName: String(request.body.companyName)
  },
  companyLog = {
    sessionID: 2,
    manipulationTypeID: 'INSERT',
    bin: company.id,
    companyName: company.companyName
  };
  console.log('Company:\n', company);
  if (PGController.validate(company, 'company')) {
    PGService.performQueryWL(
      DBQueries.insertCompanyQuery(company),
      PGService.insertRecordWL,
      function (status, data) {
        return response.status(status)
        .json(data).end();
    });
  } else {
    return response.status(400).end();
  }
})
/* @RequestService */
.put('/:id', function (request, response) {
  if (!request.params.id) {
    return response.status(400).end();
  }
  var company = {
    /* required */
    id: String(request.params.id),
    /* required length: 1 - 300 */
    companyName: String(request.body.companyName)
  },
  companyLog = {
    sessionID: 2,
    manipulationTypeID: 'UPDATE',
    bin: company.id,
    companyName: company.companyName
  };
  if (PGController.validate(company, 'company')) {
    PGService.performQueryWithoutLogging(
      DBQueries.updateCompanyQuery(company),
      PGService.updateRecord,
      function (status, data) {
        return response.status(status)
        .json(data).end();
    });
  } else {
    return response.status(400).end();
  }
})
/* @RequestService */
.delete('/:id', function (request, response) {
  if (!request.params.id) {
    return response.status(400).end();
  }
  var company = {
    /* required */
    id: String(request.params.id)
  },
  companyLog = {
    sessionID: 2,
    manipulationTypeID: 'DELETE',
    bin: company.id
  };
  if (PGController.validate(company, 'bin')) {
    PGService.performQueryWithoutLogging(
      DBQueries.deleteCompanyQuery(company),
      PGService.deleteRecord,
      function (status, data) {
        return response.status(status)
        .json(data).end();
    });
  } else {
    return response.status(400).end();
  }
});

module.exports = CompaniesRouter;
