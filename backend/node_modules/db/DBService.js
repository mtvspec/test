'use strict';

var pg = require('pg'),
Utils = require('utils'), DBUtils = new Utils();

function DBService() {
};
/**
*
*
*/
DBService.prototype.selectRecordP = function selectRecordP(query) {
  return new Promise(function (success, failure) {
    pg.connect(function (err, client, done) {
      if (err) {
        console.error('selectRecordP: connect:\n', query, '\nerror:\n', err);
        failure({
          status: 500,
          message: err.message
        });
      } else {
        client.query({
          text: query.text,
          values: query.values
        }, function (err, result) {
          var rowCount;
          if (err) {
            console.error('selectRecordP:\nquery:\n', query, '\nerror:\n', err);
            failure({
              status: 500,
              message: err.message
            });
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount > 0) {
              success({
                status: 200,
                data: result.rows
              });
            } else if (rowCount === 0) {
              success({
                status: 204,
                data: []
              });
            }
          }
        });
      }
    });
  });
};

DBService.prototype.selectRecordsP = function selectRecords(query) {
  // console.log('selectRecordsP:\n', query);
  return new Promise(function (success, failure) {
    pg.connect(function (err, client, done) {
      if (err) {
        console.error('selectRecordsP: connect:\n', query, '\nerror:\n', err);
        failure({
          status: 500,
          message: err.message
        });
      } else {
        client.query({
          text: query.text
        }, function (err, result) {
          var rowCount;
          if (err) {
            console.error('selectRecordsP: connect:\n', query, '\nerror:\n', err);
            failure({
              status: 500,
              message: err.message
            });
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount > 0) {
              success({
                status: 200,
                data: result.rows
              });
            } else if (rowCount === 0) {
              success({
                status: 204,
                data: []
              });
            }
          }
        });
      }
    });
  });
};

DBService.prototype.selectRecordsByIDP = function selectRecordsByIDP(query) {
  // console.log(query);
  return new Promise(function (success, failure) {
    pg.connect(function (err, client, done) {
      if (err) {
        console.error('selectRecordsByIDP: connect:\n', query, '\nerror:\n', err);
        failure({
          status: 500,
          message: err.message
        });
      } else {
        client.query({
          text: query.text,
          values: query.values
        }, function (err, result) {
          var rowCount;
          if (err) {
            console.error('selectRecordsByIDP: query:\n', query, '\nerror:\n', err);
            failure({
              status: 500,
              message: err.message
            });
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount > 0) {
              success({
                status: 200,
                data: result.rows
              });
            } else if (rowCount === 0) {
              success({
                status: 204,
                data: []
              });
            }
          }
        });
      }
    });
  });
};

DBService.prototype.selectRecords = function selectRecords(query, log, cb) {
  if (!query.text) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('selectRecords: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text
    }, function (err, result) {
      var rowCount, data;
      if (err) {
        console.error('selectRecords: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount > 0) {
        data = result.rows;
        client.query({
          text: log.text,
          values: log.values
        }, function (err, result) {
          if (err) {
            if (err.code === '23502') {
              console.error('Log error:', err.column);
            }
            if (err.code === '23505') {
              console.error('Log error:', err.detail);
            }
            console.error('insertRecord: query:\n', err);
            return cb(500, null);
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount === 0) {
              console.error('Not logged:', log);
            }
            if (rowCount === 1) {
              console.log('Logged');
            }
          }
        });
        return cb(200, data);
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.selectRecordsWL = function selectRecordsWL(query, cb) {
  if (!query.text) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('selectRecordsWL:\nquery:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount;
      if (err) {
        console.error('selectRecordsWL:\nquery:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount > 0) {
        return cb(200, result.rows);
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.selectRecord = function selectRecord(query, log, cb) {
  if (query.values.iin) {
    query.values.id = query.values.iin;
  }
  if (!(query.text && query.values.id)) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('selectRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount;
      if (err) {
        console.error('selectRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        client.query({
          text: log.text,
          values: log.values
        }, function (err, result) {
          if (err) {
            if (err.code === '23502') {
              console.error('Log error:', err.column);
            }
            if (err.code === '23505') {
              console.error('Log error:', err.detail);
            }
            console.error('insertRecord: query:\n', query, '\nerror:\n', err);
            return cb(500, null);
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount === 0) {
              console.error('Not logged:', log);
            }
            if (rowCount === 1) {
              console.log('Logged');
            }
          }
        });
        if (query.id === data.id) {
          return cb(200, data);
        }
      } else {
        return cb(500, null);
      }
    });
  });
};

DBService.prototype.selectRecordWL = function selectRecordWL(query, cb) {
  // console.log('selectRecordWL:', query);
  if (!query.values || (query.values.username && query.values.password)) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('selectRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount;
      if (err) {
        console.error('selectRecordWL: query: error:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount === 1) {
        return cb(200, result.rows[0]);
      } else {
        return cb(500, null);
      }
    });
  });
};

DBService.prototype.selectRecordsByIDWL = function selectRecordsByIDWL(query, cb) {
  // console.log('selectRecordsByIDWL:\n', query);
  if (!query.values || (query.values.username && query.values.password)) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('selectRecordsByIDWL: connect:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount;
      if (err) {
        console.error('selectRecordsByIDWL: query:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount >= 1) {
        return cb(200, result.rows);
      } else {
        console.log('selectRecordsByIDWL');
        return cb(500, null);
      }
    });
  });
};

DBService.prototype.insertRecord = function insertRecord(query, log, cb) {
  // console.log('InsertRecord:\n', log);
  if (!query) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('insertRecord: connect:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount, column, data;
      if (err) {
        if (err.code === '23502') {
          console.error('insertRecord: query:\n', query, '\nerror:\n', err);
          return cb(400, err.column);
        }
        if (err.code === '23505') {
          console.error('insertRecord: query:\n', query, '\nerror:\n', err);
          return cb(400, err.detail);
        }
        console.error('insertRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(400, null);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        client.query({
          text: log.text,
          values: log.values
        }, function (err, result) {
          if (err) {
            if (err.code === '23502') {
              console.error('Log error:', err.column);
            }
            if (err.code === '23505') {
              console.error('Log error:', err.detail);
            }
            console.error('insertRecord: query:\n', query, '\nerror:\n', err);
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount === 0) {
              console.error('Not logged:', query, '\nerror:\n', err);
            }
            if (rowCount === 1) {
              console.log('Logged');
            }
          }
        });
        return cb(201, data);
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.insertRecordWL = function insertRecordWL(query, cb) {
  console.log(query);
  if (!query) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('insertRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount, data;
      if (err) {
        if (err.code === '23502') {
          console.log(err.column);
          return cb(400, err.column);
        }
        if (err.code === '23505') {
          console.log(err.detail);
          return cb(400, err.detail);
        }
        console.error('insertRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        console.log('Not created');
        return cb(400, null);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        return cb(201, data);
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.updateRecord = function updateRecord(query, log, cb) {
  if (query.iin) {
    query.id = query.iin;
  }
  console.log('updateRecord:\n', log);
  if (!query) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('updateRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount, data;
      if (err) {
        if (err.code === '23502') {
          return cb(400, err.column);
        }
        if (err.code === '23505') {
          return cb(400, err.detail);
        }
        console.error('updateRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        if (log) {
          client.query({
            text: log.text,
            values: log.values
          }, function (err, result) {
            if (err) {
              if (err.code === '23502') {
                console.error('Log error:', err.column);
              }
              if (err.code === '23505') {
                console.error('Log error:', err.detail);
              }
              console.error('insertRecord: query:\n', query, '\nerror:\n', err);
            } else {
              done();
              rowCount = result.rowCount;
              if (rowCount === 0) {
                console.error('Not logged:', log);
              }
              if (rowCount === 1) {
                console.log('Logged');
              }
            }
          });
        }
        if (query.values.id === data.id) {
          return cb(200, data);
        }
      }
      return cb(500);
    });
  });
};

DBService.prototype.updateRecordWL = function updateRecordWL(query, cb) {
  if (query.iin) {
    query.id = query.iin;
  }
  console.log('updateRecord:\n', log);
  if (!query) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('updateRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount, data;
      if (err) {
        if (err.code === '23502') {
          return cb(400, err.column);
        }
        if (err.code === '23505') {
          return cb(400, err.detail);
        }
        console.error('updateRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        if (query.values.id === data.id) {
          return cb(200, data);
        }
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.deleteRecord = function deleteRecord(query, log, cb) {
  if (query.values.iin) {
    query.values.id = query.iin;
  }
  if (!query.id) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('deleteRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount, data;
      if (err) {
        console.error('deleteRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        client.query({
          text: log.text,
          values: log.values
        }, function (err, result) {
          if (err) {
            if (err.code === '23502') {
              console.error('Log error:', err.column);
            }
            if (err.code === '23505') {
              console.error('Log error:', err.detail);
            }
            console.error('insertRecord: query:\n', query, '\nerror:\n', err);
            return cb(500, null);
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount === 0) {
              console.error('Not logged:', log);
            }
            if (rowCount === 1) {
              console.log('Logged');
            }
          }
        });
        if (query.values.id === data.id) {
          return cb(200, data);
        }
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.deleteRecordWL = function deleteRecordWL(query, cb) {
  if (query.iin) {
    query.id = query.iin;
  }
  if (!query.id) {
    return cb(400, null);
  }
  pg.connect(function (err, client, done) {
    if (err) {
      console.error('deleteRecord: connect:\n', query, '\nerror:\n', err);
      return cb(500, null);
    }
    client.query({
      text: query.text,
      values: query.values
    }, function (err, result) {
      var rowCount, data;
      if (err) {
        console.error('deleteRecord: query:\n', query, '\nerror:\n', err);
        return cb(500, null);
      }
      done();
      rowCount = result.rowCount;
      if (rowCount === 0) {
        return cb(204, []);
      }
      if (rowCount === 1) {
        data = result.rows[0];
        if (query.values.id === data.id) {
          return cb(200, data);
        }
      }
      return cb(500, null);
    });
  });
};

DBService.prototype.performQuery = function performQuery(query, queryLog, queryFn, cb) {

  query = DBUtils.formatQuery(query);
  if (typeof queryLog === 'object') {
    queryLog = DBUtils.formatQuery(queryLog);
  }

  queryFn(query, queryLog,
    function (status, data) {
      if (typeof cb === 'function') {
        cb(status, data);
      }
    }
  );

};

DBService.prototype.performQueryWL = function performQueryWL(query, queryFn, cb) {
  // console.log(query);

  query = DBUtils.formatQuery(query);

  queryFn(query,
    function (status, data) {
      if (typeof cb === 'function') {
        cb(status, data);
      }
    }
  );

};

DBService.prototype.performQueryWLP = function performQueryWLP(query, queryFn, cb) {
  return new Promise(function (success, failure) {

    query = DBUtils.formatQuery(query);

    success(queryFn(query).then(
      function (success) {
        console.log(success);
      },
      function (failure) {
        console.log(failure);
      }
    ));

    failure(
      console.log('failure')
    );

  });
};

function performQuery(config, cb) {
  if (!config.query) {
    return cb(400, null);
  } else {
    config.query = DBUtils.formatQuery(config.query);
    pg.connect(function (err, client, done) {
      if (err) {
        console.error('performQuery: connect:\n', err);
        return cb(500, null);
      } else {
        client.query({
          query: config.query.text,
          values: config.query.values
        }, function (err, result) {
          var rowCount, data;
          if (err) {
            console.error('performQuery: query:\n', query, '\nerror:\n', err);
            return cb(500, null);
          } else {
            done();
            rowCount = result.rowCount;
            if (rowCount === 0) {
              return cb(204, []);
            } else {
              data = result.rows;
              if (config.log) {
                config.log = formatQuery(config.log);
                client.query({
                  query: config.log.text,
                  values: config.log.values
                }, function (err, result) {
                  var rowCount;
                  if (err) {
                    console.error('performQuery: log:\n', query, '\nerror:\n', err);
                  } else {
                    done();
                    rowCount = result.rowCount;
                    if (rowCount === 1) {
                      console.log('Logged');
                    } else {
                      console.log('Not logged');
                    }
                  }
                });
              } else {
                return cb(200, data);
              }
            }
          }
        });
      }
    });
  }
};

module.exports = DBService;
