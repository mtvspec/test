'use strict';

var bcrypt = require('bcrypt-nodejs'),
DBQueries = require('../db/DBQueries.js'),
DBService = require('../db/DBService.js'), PGService = new DBService();

function Controller() {
};
/**
* @function validateData
* @param
* {object} data object to validate
* {string} type object type name
* @return
* @name success
* {true} res success validation result
* @name failure
* {false} res failure validation result
*/
Controller.prototype.validate = function validate(data, type) {
  if (!(data && type)) {
    return false;
  }
  var res;
  switch (type) {
  case 'id':
    (typeof data.id === 'number' && data.id > 0) ? res = true : res = false;
    return res;
    break;
  case 'taskData':
    if (data) {
      (typeof data.taskName === 'string' && data.taskName.length > 0 && data.taskName.length <= 300) ? res = true : res = false;
      if (data.taskDescription) {
        (res === true && typeof data.taskDescription === 'string' && data.taskDescription.length > 0 && data.taskDescription.length <= 500) ? res = true : res = false;
      }
      return false;
    }
    return false;
    break;
  case 'task':
    if (data) {
      (typeof data.id === 'number' && data.id > 0) ? res = true: res = false
      (res === true && typeof data.taskName === 'number' && data.taskName.length > 0 && data.taskName.length <= 300) ? res = true : res = false;
      if (data.taskDescription) {
        (res === true && typeof data.taskDescription === 'string' && data.taskDescription.length > 0 && data.taskDescription.length <= 500) ? res = true : res = false;
      }
      return false;
    }
    return false;
    break;
  case 'iin':
    return iinValid(data.id);
    break;
  case 'personData': // TODO реализовать проверку на наличие букв (только латиница и кирилица)
    if (!(data.id && data.lastName && data.firstName && data.dob && data.genderID)) {
      return false;
    }
    if (!iinValid(data.id)) {
      return false;
    }
    if (!nameValid(data.lastName, 1, 200)) {
      return false;
    }
    if (!nameValid(data.firstName, 1, 200)) {
      return false;
    }
    if (!dateValid(data.dob)) {
      return false;
    }
    if (!genderIDValid(data.genderID)) {
      return false;
    }
    if (data.middleName) {
      return nameValid(data.middleName, 1, 300);
    }
    if (data.middleName === undefined) {
      data.middleName = '';
    }
    return true;
    break;
  case 'bin':
    return binValid(data.id);
    break;
  case 'company':
    if (!(data.id && data.companyName)) {
      return false;
    }
    if (!binValid(data.id)) {
      console.log('bin');
      return false;
    }
    if (!nameValid(data.companyName, 1, 500)) {
      console.log('name');
      return false;
    }
    return true;
    break;
  case 'user':
    if (!(data.username, data.password)) {
      return false;
    }
    if (!passwordValid(data)) {
      return false;
    }
    return true;
  default:
    throw new Error('Type not found');
    break;
  }
};

function nameValid(text, minLength, maxLength) {
  if (typeof text === 'string') {
    return text.length > minLength && text.length <= maxLength;
  } else {
    return false;
  }
};

function dateValid(date) {
  if (date instanceof Date) {
    return true;
  } else {
    return false;
  }
};

function genderIDValid(gender) {
  if (typeof gender === 'string') {
    return gender === 'M' || gender === 'F';
  } else {
    return false;
  }
};

function iinValid(iin) {
  if (!iinValid.formatRegExp) {
    iinValid.formatRegExp = new RegExp(/^\d{2}(0[1-9]|1[0-2])(0[1-9]|[1-2]\d|3[01])[0-6]\d{5}$/);
  }
  if (typeof iin === 'string') {
    var isLengthValid = iin.length === 12;
    var isFormatValid = iinValid.formatRegExp.test(iin);
    return isLengthValid && isFormatValid;
  } else {
    return false;
  }
};

function binValid(bin) {
  if (!binValid.formatRegExp) {
    binValid.formatRegExp = new RegExp(/^\d{2}(0[1-9]|1[0-2])(0[1-9]|[1-2]\d|3[01])[0-6]\d{5}$/);
  }
  if (typeof bin === 'string') {
    var isLengthValid = bin.length === 12;
    var isFormatValid = binValid.formatRegExp.test(bin);
    return isLengthValid && isFormatValid;
  } else {
    return false;
  }
};

function passwordValid(user) {
  console.log('password');
  user.password = bcrypt.hashSync(user.password);
  PGService.performQuery(
    DBQueries.selectUserQuery(user),
    DBService.selectRecord,
    function (status, data) {
      if (status === 200) {
        if (bcrypt.compareSync(data.pass, user.password)) {
          return true;
        }
      } else {
        return false;
      }
    });
};

module.exports = Controller;
